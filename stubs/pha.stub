#!/bin/bash

# --- 1. ENVIRONMENT LOAD ---
if [ -f ./zd_server_franken/.env ]; then
    export $(grep -v '^#' ./zd_server_franken/.env | xargs)
fi

# Configuration
DOMAIN="${APP_DOMAIN:-{{APP_DOMAIN}}}"
APP_ENV="${APP_ENV:-local}"
SERVICE_NAME="{{SERVICE_NAME}}"
DB_CONTAINER="{{DB_CONTAINER}}"
DB_NAME="laravel"
DB_USER="laravelUser"
DB_PASS="laravel@UserPassword"

# Paths
COMPOSE_FILE="./zd_server_franken/docker-compose-traefik.yml"
TRAEFIK_COMPOSE="./zd_server_franken/docker-compose-traefik-master.yml"
STANDALONE_COMPOSE="./zd_server_franken/docker-compose-standalone.yml"

# Infrastructure
TRAEFIK_NETWORK="{{TRAEFIK_NETWORK}}"
TRAEFIK_CONTAINER="{{TRAEFIK_CONTAINER}}"

# Colors
G='\033[0;32m'
Y='\033[1;33m'
R='\033[0;31m'
C='\033[0;36m'
NC='\033[0m'

# --- 2. HELPERS ---

get_node() {
    docker ps -q -f "label=com.docker.compose.service=$SERVICE_NAME" | head -n 1
}

update_hosts_file() {
    local TARGET_DOMAIN=$1
    echo -e "${Y}Syncing IPv4 & IPv6 Hosts for $TARGET_DOMAIN...${NC}"

    local IPV4=$(hostname -I 2>/dev/null | awk '{print $1}')
    local IPV6=$(hostname -I 2>/dev/null | awk '{print $2}')

    # macOS fallback
    if [ -z "$IPV4" ]; then
        IPV4=$(ipconfig getifaddr en0 2>/dev/null || echo "127.0.0.1")
    fi

    sudo sed -i.bak "/$TARGET_DOMAIN/d" /etc/hosts 2>/dev/null || sudo sed -i '' "/$TARGET_DOMAIN/d" /etc/hosts

    echo "127.0.0.1 $TARGET_DOMAIN" | sudo tee -a /etc/hosts > /dev/null
    echo "::1 $TARGET_DOMAIN" | sudo tee -a /etc/hosts > /dev/null

    [ ! -z "$IPV4" ] && [ "$IPV4" != "127.0.0.1" ] && echo "$IPV4 $TARGET_DOMAIN" | sudo tee -a /etc/hosts > /dev/null
    [ ! -z "$IPV6" ] && [[ "$IPV6" == *:* ]] && echo "$IPV6 $TARGET_DOMAIN" | sudo tee -a /etc/hosts > /dev/null

    echo -e "${G}DNS Mapping updated.${NC}"
}

pha_check_infrastructure() {
    echo -e "${Y}Checking Infrastructure...${NC}"
    if ! docker network inspect "$TRAEFIK_NETWORK" >/dev/null 2>&1; then
        docker network create "$TRAEFIK_NETWORK"
    fi

    if [ ! "$(docker ps -q -f name=^/${TRAEFIK_CONTAINER}$)" ]; then
        echo -e "${Y}Traefik missing. Starting master...${NC}"
        docker compose -f "$TRAEFIK_COMPOSE" --env-file ./zd_server_franken/.env up -d
    else
        echo -e "${G}Traefik active.${NC}"
    fi
}

# --- 3. CORE COMMANDS ---

pha_start() {
    echo -e "${C}Env: ${APP_ENV^^} | Domain: $DOMAIN | Server: FrankenPHP${NC}"
    pha_check_infrastructure
    [[ "$APP_ENV" == "local" ]] && update_hosts_file "$DOMAIN"

    export APP_DOMAIN="$DOMAIN"
    export APP_URL="https://$DOMAIN"
    docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env up -d --build
}

pha_start_standalone() {
    echo -e "${C}Env: ${APP_ENV^^} | Domain: $DOMAIN | Server: FrankenPHP (Standalone)${NC}"
    [[ "$APP_ENV" == "local" ]] && update_hosts_file "$DOMAIN"

    export APP_DOMAIN="$DOMAIN"
    export APP_URL="https://$DOMAIN"
    docker compose -f "$STANDALONE_COMPOSE" --env-file ./zd_server_franken/.env up -d --build
}

pha_reload() {
    echo -e "${Y}Reloading all $SERVICE_NAME replicas...${NC}"
    NODES=$(docker ps -q -f "label=com.docker.compose.service=$SERVICE_NAME")
    for NODE in $NODES; do
        docker exec "$NODE" php artisan octane:reload
    done
    echo -e "${G}Workers reloaded.${NC}"
}

pha_reboot() {
    echo -e "${Y}Restarting project services...${NC}"
    docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env restart
    echo -e "${G}Services rebooted.${NC}"
}

pha_scale() {
    NUM=$2
    [[ -z "$NUM" ]] && { echo -e "${R}Usage: ./pha scale 3${NC}"; exit 1; }
    export APP_DOMAIN="$DOMAIN"
    docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env up -d --scale "$SERVICE_NAME=$NUM" --no-recreate
}

pha_delete() {
    echo -e "${R}DANGER: Wiping Images, Volumes, and Cache.${NC}"
    read -p "Confirm? (y/N): " confirm
    if [[ $confirm == [yY] ]]; then
        docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env down --rmi all -v
        docker builder prune --all --force
        echo -e "${G}Project wiped.${NC}"
    fi
}

pha_status() {
    echo -e "${C}=== FrankenPHP Status ===${NC}"
    echo -e "${Y}Containers:${NC}"
    docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env ps
    echo ""
    echo -e "${Y}Octane Workers:${NC}"
    NODE=$(get_node)
    if [ ! -z "$NODE" ]; then
        docker exec "$NODE" php artisan octane:status 2>/dev/null || echo "Octane running"
    else
        echo -e "${R}No FrankenPHP container running${NC}"
    fi
}

# --- COMMAND ROUTER ---
case "$1" in
    start)      pha_start ;;
    standalone) pha_start_standalone ;;
    stop)       docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env down ;;
    reload)     pha_reload ;;
    reboot)     pha_reboot ;;
    scale)      pha_scale "$@" ;;
    delete)     pha_delete ;;
    fresh)      [[ "$APP_ENV" == "production" ]] && exit 1; pha_delete; pha_start ;;
    ls)         docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env ps ;;
    logs)       docker compose -f "$COMPOSE_FILE" --env-file ./zd_server_franken/.env logs -f $SERVICE_NAME ;;
    ssh)        docker exec -it $(get_node) bash || docker exec -it $(get_node) sh ;;
    art)        shift; docker exec -it $(get_node) php artisan "$@" ;;
    composer)   shift; docker exec -it $(get_node) composer "$@" ;;
    npm)        shift; docker exec -it $(get_node) npm "$@" ;;
    tinker)     docker exec -it $(get_node) php artisan tinker ;;
    status)     pha_status ;;
    help|*)
        echo -e "${G}Pha CLI v1.0 (FrankenPHP)${NC}"
        echo ""
        echo -e "${Y}Lifecycle:${NC}"
        echo "  start       Start with Traefik reverse proxy"
        echo "  standalone  Start without Traefik (FrankenPHP handles SSL)"
        echo "  stop        Stop all containers"
        echo "  reboot      Restart all services"
        echo "  reload      Reload Octane workers (zero downtime)"
        echo "  fresh       Wipe and rebuild (local only)"
        echo "  delete      Remove all containers, images, volumes"
        echo ""
        echo -e "${Y}Scaling:${NC}"
        echo "  scale [n]   Scale to n replicas (e.g., ./pha scale 4)"
        echo ""
        echo -e "${Y}Development:${NC}"
        echo "  art [cmd]   Run artisan command"
        echo "  composer    Run composer command"
        echo "  npm         Run npm command"
        echo "  tinker      Open Laravel tinker"
        echo "  ssh         Shell into container"
        echo ""
        echo -e "${Y}Monitoring:${NC}"
        echo "  ls          List running containers"
        echo "  logs        Tail FrankenPHP logs"
        echo "  status      Show detailed status"
        ;;
esac
